# Nostr-inspired ä¸­å¿ƒåŒ– IM æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

![](./README/v1.png)

## 1. è®¾è®¡èƒŒæ™¯ä¸ç›®æ ‡

æœ¬ç³»ç»Ÿæ˜¯ä¸€å¥— **å‚è€ƒ Nostr åè®®æ€æƒ³ï¼ˆEvent / Relay / Client è§£è€¦ï¼‰**ï¼Œä½†é¢å‘**å·¥ç¨‹è½åœ°ä¸ä¸­å¿ƒåŒ–è¿è¥**çš„å³æ—¶é€šè®¯ï¼ˆIMï¼‰æ¶æ„ã€‚

è®¾è®¡ç›®æ ‡ï¼š

* ä¿ç•™ Nostr çš„ **äº‹ä»¶æ¨¡å‹ï¼ˆEventï¼‰** ä¸ **Relay è½»é€»è¾‘å­˜å‚¨** ä¼˜ç‚¹
* æä¾›ä¸­å¿ƒåŒ– IM å¿…éœ€çš„ **è´¦å·ã€å…³ç³»ã€æƒé™ã€æ¨é€ã€é£æ§** èƒ½åŠ›
* æ”¯æŒ **å•èŠ / ç¾¤èŠ / æ–‡ä»¶ / å›ä¿¡ / æ’¤é”€** ç­‰å®Œæ•´ IM åŠŸèƒ½
* åè®®å±‚è½»é‡ï¼ˆMsgPackï¼‰ã€å¯ç‰ˆæœ¬åŒ–ã€å¼ºæ‰©å±•
---

## 2. æ€»ä½“æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿç”±äº”ç±»æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

1. **Clientï¼ˆMobile/Webï¼‰**ï¼š

   * ç”¨æˆ·ç•Œé¢
   * åè®®ç¼–è§£ç ï¼ˆMsgPackï¼‰
   * æœ¬åœ°çŠ¶æ€ï¼ˆä¼šè¯ã€æ¶ˆæ¯ï¼‰

2. **Gateway é›†ç¾¤**ï¼ˆè¿æ¥ä¸æ¨é€å±‚ï¼‰ï¼š

   * ç»Ÿä¸€å®¢æˆ·ç«¯å…¥å£
   * WebSocket é•¿è¿æ¥ç®¡ç†
   * é‰´æƒã€åè®®é€‚é…ã€æ¶ˆæ¯è·¯ç”±ä¸æ¨é€

3. **SeaKingï¼ˆç”¨æˆ·ä¸å…³ç³»ä¸­å¿ƒï¼‰**ï¼š

   * Auth / æ³¨å†Œ / ç™»å½•
   * ç”¨æˆ·ç®¡ç†
   * ç”¨æˆ·å…³ç³»ï¼ˆå¥½å‹ã€ç¾¤æˆå‘˜ã€è§’è‰²ï¼‰
   * ç”¨æˆ·çŠ¶æ€ç»´æŠ¤
   * ç³»ç»Ÿâ€œçœŸç›¸æºâ€ï¼ˆSource of Truthï¼‰

4. **Relay é›†ç¾¤ï¼ˆäº‹ä»¶å­˜å‚¨å±‚ï¼‰**ï¼š

   * åªè´Ÿè´£äº‹ä»¶å­˜å‚¨ä¸æŸ¥è¯¢
   * ä¸ç†è§£ä¸šåŠ¡è¯­ä¹‰
   * å¯æ¨ªå‘æ‰©å±•

5. **å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSS/COSï¼‰**ï¼š

   * æ–‡ä»¶ã€å›¾ç‰‡ã€è¯­éŸ³ç­‰å¤§å¯¹è±¡å­˜å‚¨

---

## 3. æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 3.1 èŒè´£ä¸¥æ ¼æ‹†åˆ†

| æ¨¡å—      | ä¸»è¦èŒè´£       | ä¸æ‰¿æ‹…èŒè´£   |
| ------- | ---------- | ------- |
| Client  | UIã€ç¼–è§£ç ã€åŠ è§£å¯† | æƒé™åˆ¤æ–­ã€å­˜å‚¨ |
| Gateway | è¿æ¥ã€è·¯ç”±ã€æ¨é€   | ç”¨æˆ·å…³ç³»çœŸç›¸  |
| SeaKing | ç”¨æˆ·/å…³ç³»/æƒé™   | æ¶ˆæ¯æ¨é€    |
| Relay   | äº‹ä»¶å­˜å‚¨       | ä¸šåŠ¡é€»è¾‘    |
| S3      | æ–‡ä»¶å­˜å‚¨       | æ¶ˆæ¯ç´¢å¼•    |

### 3.2 Relay è½»é€»è¾‘åŸåˆ™ï¼ˆNostr ç²¾ç¥ï¼‰

Relay è¢«è®¾è®¡ä¸ºï¼š

* **å“‘å­˜å‚¨ï¼ˆDumb Storeï¼‰**
* åªç†è§£ Event çš„æœ€å°å­—æ®µï¼ˆcid / mid / kind / tags / payloadï¼‰
* ä¸ä¸»åŠ¨è°ƒç”¨ SeaKing
* ä¸ç»´æŠ¤ä¼šè¯ã€æˆå‘˜ã€æƒé™

---

## 4. æ¶ˆæ¯ä¸äº‹ä»¶æ¨¡å‹

### 4.1 Event æ€»ä½“æ¨¡å‹

æ‰€æœ‰æ¶ˆæ¯ã€æ§åˆ¶è¡Œä¸ºéƒ½æŠ½è±¡ä¸º **Event**ã€‚

Event æ˜¯ç³»ç»Ÿä¸­å”¯ä¸€çš„â€œæ¶ˆæ¯åŸå­â€ã€‚

### 4.2 åè®®å°è£…ï¼ˆEnvelopeï¼‰

æ‰€æœ‰ç½‘ç»œæ¶ˆæ¯ä½¿ç”¨ MsgPack Map å°è£…ï¼š

```
{
  0: v,        // åè®®ç‰ˆæœ¬
  1: cmd,      // å‘½ä»¤ç±»å‹
  2: seq,      // å®¢æˆ·ç«¯åºåˆ—å·
  3: sid,      // ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
  4: body,     // è´Ÿè½½
  15: ext      // æ‰©å±•å­—æ®µï¼ˆå¯é€‰ï¼‰
}
```

### 4.3 Event Body ç»“æ„

```
body = {
  0: ev_v,     // äº‹ä»¶ç‰ˆæœ¬
  1: cid,      // ä¼šè¯IDï¼ˆå•èŠ/ç¾¤èŠï¼‰
  2: k,        // kindï¼ˆäº‹ä»¶ç±»å‹ï¼‰
  3: mid,      // æ¶ˆæ¯IDï¼ˆæœåŠ¡ç«¯ç”Ÿæˆï¼‰
  4: t,        // æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  5: flg,      // flags ä½å›¾
  6: tags,     // å…³è”æ ‡ç­¾
  7: data,     // ç»“æ„åŒ–æ¶ˆæ¯ä½“
  8: sig,      // å¯é€‰ç­¾å
  15: ext      // æ‰©å±•å­—æ®µ
}
```

---

## 5. æ¶ˆæ¯ç±»å‹ï¼ˆKindsï¼‰

| Kind | å«ä¹‰         | æ˜¯å¦æŒä¹…åŒ– | è¯´æ˜ |
| ---- | ---------- | -------- | ---- |
| 1    | æ–‡æœ¬æ¶ˆæ¯       | âœ… | åŸºç¡€æ¶ˆæ¯ç±»å‹ |
| 3    | æ–‡ä»¶æ¶ˆæ¯ï¼ˆå¼•ç”¨æ–‡ä»¶ï¼‰ | âœ… | å›¾ç‰‡/è¯­éŸ³/æ–‡ä»¶ |
| 5    | æ’¤é”€æ¶ˆæ¯       | âœ… | è½¯åˆ é™¤ |
| 7    | ç¼–è¾‘æ¶ˆæ¯       | âœ… | ç¼–è¾‘å·²å‘é€æ¶ˆæ¯ |
| 10   | å·²è¯»å›æ‰§       | âœ… | å¯èšåˆå­˜å‚¨ |
| 11   | æ­£åœ¨è¾“å…¥       | âŒ | ä»…è½¬å‘ä¸å­˜å‚¨ |
| 12   | æ¶ˆæ¯ååº”       | âœ… | Reaction/è¡¨æƒ…å›åº” |
| 13   | è½¬å‘æ¶ˆæ¯       | âœ… | å•æ¡/åˆå¹¶è½¬å‘ |

### 5.1 æ–‡æœ¬æ¶ˆæ¯ï¼ˆKind=1ï¼‰

```
data = {
  0: "hello world"
}
```

### 5.2 æ–‡ä»¶æ¶ˆæ¯ï¼ˆKind=3ï¼‰

```
data = {
  0: fid,        // æ–‡ä»¶ID
  1: name,       // æ–‡ä»¶å
  2: size,       // æ–‡ä»¶å¤§å°
  3: mime,       // MIME
  4: sha256,     // å“ˆå¸Œ
  5: url         // ä¸‹è½½åœ°å€
}
```

---

## 6. å›ä¿¡ï¼ˆReplyï¼‰è®¾è®¡

### 6.1 Reply çš„å»ºæ¨¡æ–¹å¼

* Reply ä¸å¼•å…¥æ–° kind
* ä½¿ç”¨ **tags** å»ºç«‹å¼•ç”¨å…³ç³»

### 6.2 Reply Tag å®šä¹‰

```
[1, mid]   // reply_to
```

### 6.3 ç¤ºä¾‹

```
tags = [ [1, 9000123] ]
data = { 0: "æ”¶åˆ°" }
```

---

## 7. æ’¤é”€æ¶ˆæ¯ï¼ˆRevokeï¼‰è®¾è®¡

### 7.1 æ’¤é”€æ¨¡å‹

* æ’¤é”€æ˜¯ä¸€ä¸ªæ–°çš„ Event
* ä¸ç‰©ç†åˆ é™¤åŸæ¶ˆæ¯

### 7.2 Revoke Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 5    | æ’¤é”€æ¶ˆæ¯ |

### 7.3 Revoke Tag

```
[6, mid]   // revoke_target
```

### 7.4 Revoke Data

```
data = {
  0: scope,     // 1=å…¨ä½“å¯è§, 2=ä»…è‡ªå·±
  1: reason     // æ’¤é”€åŸå› ï¼ˆå¯é€‰ï¼‰
}
```

### 7.5 æœåŠ¡ç«¯æ ¡éªŒè§„åˆ™

* ç›®æ ‡æ¶ˆæ¯å¿…é¡»å­˜åœ¨ä¸”å±äºåŒ cid
* å•èŠï¼šåªèƒ½æ’¤é”€è‡ªå·±å‘é€çš„æ¶ˆæ¯
* ç¾¤èŠï¼š

  * æ™®é€šç”¨æˆ·ï¼šæ’¤é”€è‡ªå·±æ¶ˆæ¯
  * ç®¡ç†å‘˜ï¼šå¯æ’¤é”€ä»–äººæ¶ˆæ¯
* å¯é…ç½®æ—¶é—´çª—å£ï¼ˆå¦‚ 2 åˆ†é’Ÿï¼‰

---

## 8. ç¼–è¾‘æ¶ˆæ¯ï¼ˆEditï¼‰è®¾è®¡

### 8.1 ç¼–è¾‘æ¨¡å‹

* ç¼–è¾‘æ˜¯ä¸€ä¸ªæ–°çš„ Eventï¼ˆKind=7ï¼‰
* ä¸è¦†ç›–åŸæ¶ˆæ¯ï¼Œä¿ç•™ç¼–è¾‘å†å²
* å®¢æˆ·ç«¯å±•ç¤ºæœ€æ–°ç‰ˆæœ¬ï¼Œå¯æŸ¥çœ‹å†å²

### 8.2 Edit Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 7    | ç¼–è¾‘æ¶ˆæ¯ |

### 8.3 Edit Tag

```
[6, mid]   // edit_targetï¼ˆæŒ‡å‘è¢«ç¼–è¾‘çš„åŸæ¶ˆæ¯ï¼‰
```

### 8.4 Edit Data

```
data = {
  0: "æ–°çš„æ¶ˆæ¯å†…å®¹",     // ç¼–è¾‘åçš„å†…å®¹
  1: edit_version       // ç¼–è¾‘ç‰ˆæœ¬å·ï¼ˆä»1å¼€å§‹é€’å¢ï¼‰
}
```

### 8.5 æœåŠ¡ç«¯æ ¡éªŒè§„åˆ™

* ç›®æ ‡æ¶ˆæ¯å¿…é¡»å­˜åœ¨ä¸”å±äºåŒ cid
* åªèƒ½ç¼–è¾‘è‡ªå·±å‘é€çš„æ¶ˆæ¯
* åªèƒ½ç¼–è¾‘ Kind=1ï¼ˆæ–‡æœ¬æ¶ˆæ¯ï¼‰
* å¯é…ç½®æ—¶é—´çª—å£ï¼ˆå¦‚ 24 å°æ—¶å†…å¯ç¼–è¾‘ï¼‰
* edit_version å¿…é¡»é€’å¢

### 8.6 ç¤ºä¾‹

```
// åŸæ¶ˆæ¯ mid=9000123
{ k: 1, data: { 0: "hello" } }

// ç¼–è¾‘äº‹ä»¶
{
  k: 7,
  tags: [ [6, 9000123] ],
  data: { 0: "hello world", 1: 1 }
}
```

---

## 9. å·²è¯»å›æ‰§ï¼ˆRead Receiptï¼‰è®¾è®¡

### 9.1 å·²è¯»æ¨¡å‹

* å·²è¯»å›æ‰§æ˜¯ Eventï¼ˆKind=10ï¼‰
* é‡‡ç”¨"æ°´ä½çº¿"æ¨¡å¼ï¼šåªå‘å·²è¯»åˆ°çš„æœ€åä¸€æ¡æ¶ˆæ¯ID
* ä¹‹å‰çš„æ¶ˆæ¯éƒ½è§†ä¸ºå·²è¯»

### 9.2 Read Receipt Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 10   | å·²è¯»å›æ‰§ |

### 9.3 Read Receipt Data

```
data = {
  0: last_read_mid    // å·²è¯»åˆ°çš„æœ€åä¸€æ¡æ¶ˆæ¯ID
}
```

### 9.4 å­˜å‚¨ç­–ç•¥

* åŒä¸€ cid + uid ä¸‹å¤šæ¡å›æ‰§åªä¿ç•™æœ€æ–°
* ç¾¤èŠåœºæ™¯ï¼šæŒ‰ uid å­˜å‚¨å„è‡ªçš„å·²è¯»ä½ç½®
* å¯èšåˆå‹ç¼©å­˜å‚¨

### 9.5 ç¤ºä¾‹

```
{
  k: 10,
  cid: "123",
  data: { 0: 9000456 }   // å·²è¯»åˆ°æ¶ˆæ¯ID 9000456
}
```

---

## 10. æ­£åœ¨è¾“å…¥ï¼ˆTyping Indicatorï¼‰è®¾è®¡

### 10.1 Typing æ¨¡å‹

* Typing æ˜¯ Eventï¼ˆKind=11ï¼‰
* **ä¸æŒä¹…åŒ–**ï¼šGateway ç›´æ¥è½¬å‘ï¼Œä¸å†™ Relay
* ç”¨äºå®æ—¶æ˜¾ç¤ºå¯¹æ–¹è¾“å…¥çŠ¶æ€

### 10.2 Typing Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 11   | æ­£åœ¨è¾“å…¥ |

### 10.3 Typing Data

```
data = {
  0: state    // 1=å¼€å§‹è¾“å…¥, 0=åœæ­¢è¾“å…¥
}
```

### 10.4 å®¢æˆ·ç«¯è¡Œä¸º

* å¼€å§‹è¾“å…¥æ—¶å‘é€ state=1
* åœæ­¢è¾“å…¥æˆ–å‘é€æ¶ˆæ¯åå‘é€ state=0
* è¶…æ—¶æœºåˆ¶ï¼š5ç§’æ— æ–°è¾“å…¥è‡ªåŠ¨å‘ state=0
* æ¥æ”¶ç«¯ï¼šæ”¶åˆ° state=1 åæ˜¾ç¤º"å¯¹æ–¹æ­£åœ¨è¾“å…¥..."ï¼Œè¶…æ—¶æˆ–æ”¶åˆ° state=0 åéšè—

### 10.5 ç¾¤èŠç­–ç•¥

* å¤§ç¾¤ï¼ˆå¦‚ >100äººï¼‰å¯å…³é—­æ­¤åŠŸèƒ½ä»¥å‡å°‘æµé‡
* æˆ–åªæ˜¾ç¤º"Näººæ­£åœ¨è¾“å…¥"

---

## 11. æ¶ˆæ¯ååº”ï¼ˆReactionï¼‰è®¾è®¡

### 11.1 Reaction æ¨¡å‹

* Reaction æ˜¯ Eventï¼ˆKind=12ï¼‰
* æ”¯æŒ emoji è¡¨æƒ…å›åº”
* åŒä¸€ç”¨æˆ·å¯å¯¹åŒä¸€æ¶ˆæ¯å‘å¤šä¸ªä¸åŒ emoji

### 11.2 Reaction Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 12   | æ¶ˆæ¯ååº” |

### 11.3 Reaction Tag

```
[6, mid]   // reaction_targetï¼ˆæŒ‡å‘ç›®æ ‡æ¶ˆæ¯ï¼‰
```

### 11.4 Reaction Data

```
data = {
  0: emoji,     // è¡¨æƒ…ç¬¦å·ï¼Œå¦‚ "ğŸ‘" "â¤ï¸" "ğŸ˜‚"
  1: action     // 1=æ·»åŠ , 0=å–æ¶ˆ
}
```

### 11.5 å®¢æˆ·ç«¯å±•ç¤º

* èšåˆå±•ç¤ºï¼š`ğŸ‘ 3  â¤ï¸ 5`
* ç‚¹å‡»å¯æŸ¥çœ‹å…·ä½“æ˜¯è°ååº”çš„
* å†æ¬¡ç‚¹å‡»åŒä¸€ emoji å‘é€ action=0 å–æ¶ˆ

### 11.6 ç¤ºä¾‹

```
// ç»™æ¶ˆæ¯ 9000123 ç‚¹èµ
{
  k: 12,
  tags: [ [6, 9000123] ],
  data: { 0: "ğŸ‘", 1: 1 }
}

// å–æ¶ˆç‚¹èµ
{
  k: 12,
  tags: [ [6, 9000123] ],
  data: { 0: "ğŸ‘", 1: 0 }
}
```

---

## 12. æ¶ˆæ¯è½¬å‘ï¼ˆForwardï¼‰è®¾è®¡

### 12.1 Forward æ¨¡å‹

* è½¬å‘æ˜¯ Eventï¼ˆKind=13ï¼‰
* æ”¯æŒå•æ¡è½¬å‘å’Œåˆå¹¶è½¬å‘
* ä¿ç•™åŸæ¶ˆæ¯æ¥æºä¿¡æ¯

### 12.2 Forward Kind

| Kind | å«ä¹‰   |
| ---- | ---- |
| 13   | è½¬å‘æ¶ˆæ¯ |

### 12.3 Forward Tags

```
[8, source_cid]    // åŸä¼šè¯ID
[9, source_mid]    // åŸæ¶ˆæ¯IDï¼ˆå•æ¡è½¬å‘æ—¶ï¼‰
```

### 12.4 Forward Data

```
data = {
  0: forward_type,    // 1=å•æ¡è½¬å‘, 2=åˆå¹¶è½¬å‘
  1: snapshot         // æ¶ˆæ¯å¿«ç…§ï¼ˆé˜²æ­¢åŸæ¶ˆæ¯è¢«åˆ ï¼‰
}
```

### 12.5 å•æ¡è½¬å‘ç¤ºä¾‹

```
{
  k: 13,
  cid: "target_cid",
  tags: [ [8, "source_cid"], [9, 9000123] ],
  data: {
    0: 1,
    1: { k: 1, data: { 0: "åŸæ¶ˆæ¯å†…å®¹" }, sender: "user123", t: 1700000000 }
  }
}
```

### 12.6 åˆå¹¶è½¬å‘ç¤ºä¾‹

```
{
  k: 13,
  cid: "target_cid",
  tags: [ [8, "source_cid"] ],
  data: {
    0: 2,
    1: [
      { k: 1, data: { 0: "æ¶ˆæ¯1" }, sender: "user1", t: 1700000001 },
      { k: 1, data: { 0: "æ¶ˆæ¯2" }, sender: "user2", t: 1700000002 },
      { k: 3, data: { 0: "fid", 1: "image.png", ... }, sender: "user1", t: 1700000003 }
    ]
  }
}
```

### 12.7 æƒé™æ ¡éªŒ

* ä¸èƒ½è½¬å‘ç§å¯†ä¼šè¯å†…å®¹ï¼ˆæœåŠ¡ç«¯æ£€æŸ¥æ¥æºä¼šè¯æƒé™ï¼‰

---

## 13. @æåŠï¼ˆMentionï¼‰è®¾è®¡

### 13.1 Mention æ¨¡å‹

* @æåŠ **ä¸å¼•å…¥æ–° Kind**
* é€šè¿‡ **tags** æ‰©å±•å®ç°
* å¯ç”¨äºä»»ä½•æ¶ˆæ¯ç±»å‹ï¼ˆKind=1, 3 ç­‰ï¼‰

### 13.2 Mention Tag

```
[2, uid]      // @æŸä¸ªç”¨æˆ·
[2, "all"]    // @å…¨ä½“æˆå‘˜ï¼ˆç‰¹æ®Šå€¼ï¼‰
```

### 13.3 ç¤ºä¾‹

```
{
  k: 1,
  cid: "group_123",
  tags: [
    [2, "user_001"],
    [2, "user_002"]
  ],
  data: { 0: "hello @å¼ ä¸‰ @æå›› è¯·æŸ¥çœ‹é™„ä»¶" }
}

// @å…¨ä½“æˆå‘˜
{
  k: 1,
  cid: "group_123",
  tags: [ [2, "all"] ],
  data: { 0: "@æ‰€æœ‰äºº æ˜å¤©å¼€ä¼š" }
}
```

### 13.4 æœåŠ¡ç«¯è¡Œä¸º

* è¢«@çš„ç”¨æˆ·æ¨é€ä¼˜å…ˆçº§æå‡
* @all éœ€è¦æƒé™æ§åˆ¶ï¼ˆç®¡ç†å‘˜/ç¾¤ä¸»ï¼‰
* å¯ç”¨äºæœªè¯»æ¶ˆæ¯çš„ç‰¹æ®Šæ ‡è®°

---

## 14. æ¶ˆæ¯æœç´¢ï¼ˆSearchï¼‰åè®®

### 14.1 æœç´¢æ¨¡å‹

* æœç´¢æ˜¯ **è¯·æ±‚/å“åº”åè®®**ï¼Œä¸æ˜¯ Event
* Relay éœ€å»ºç«‹å…¨æ–‡ç´¢å¼•ï¼ˆæ¨è ES/MeiliSearchï¼‰

### 14.2 æœç´¢è¯·æ±‚

```
{
  cmd: "search",
  body: {
    cid: "123",              // å¯é€‰ï¼šé™å®šä¼šè¯
    q: "å…³é”®è¯",              // æœç´¢è¯
    kinds: [1],              // å¯é€‰ï¼šé™å®šæ¶ˆæ¯ç±»å‹
    before: 1700000000,      // å¯é€‰ï¼šæ—¶é—´èŒƒå›´ä¸Šé™
    after: 1699000000,       // å¯é€‰ï¼šæ—¶é—´èŒƒå›´ä¸‹é™
    limit: 20,               // è¿”å›æ¡æ•°
    offset: 0                // åç§»é‡ï¼ˆåˆ†é¡µï¼‰
  }
}
```

### 14.3 æœç´¢å“åº”

```
{
  cmd: "search_result",
  body: {
    total: 156,              // æ€»åŒ¹é…æ•°
    items: [
      {
        mid: 9000123,
        cid: "123",
        k: 1,
        data: { 0: "åŒ…å«å…³é”®è¯çš„æ¶ˆæ¯" },
        t: 1700000000,
        highlight: "...åŒ…å«<em>å…³é”®è¯</em>çš„æ¶ˆæ¯..."
      }
    ]
  }
}
```

### 14.4 æƒé™æ§åˆ¶

* åªèƒ½æœç´¢è‡ªå·±å‚ä¸çš„ä¼šè¯
* Gateway éœ€æ ¡éªŒç”¨æˆ·å¯¹ cid çš„è®¿é—®æƒé™

---

## 15. Tags æ±‡æ€»è¡¨

| Tagç±»å‹ | æ ¼å¼ | ç”¨é€” | ä½¿ç”¨åœºæ™¯ |
| ------- | ---- | ---- | -------- |
| 1 | `[1, mid]` | å›å¤å¼•ç”¨ | å›å¤æ¶ˆæ¯ |
| 2 | `[2, uid]` | @æåŠ | æ–‡æœ¬æ¶ˆæ¯ä¸­@æŸäºº |
| 6 | `[6, mid]` | ç›®æ ‡æ¶ˆæ¯å¼•ç”¨ | æ’¤é”€/ç¼–è¾‘/Reaction |
| 8 | `[8, cid]` | è½¬å‘æ¥æºä¼šè¯ | æ¶ˆæ¯è½¬å‘ |
| 9 | `[9, mid]` | è½¬å‘æ¥æºæ¶ˆæ¯ | å•æ¡è½¬å‘ |

---

## 16. Gateway è®¾è®¡è¯´æ˜

Gateway è´Ÿè´£ï¼š

* WebSocket è¿æ¥ç®¡ç†
* é‰´æƒï¼ˆtoken â†’ uidï¼‰
* æ¶ˆæ¯è·¯ç”±ï¼ˆcid â†’ åœ¨çº¿ç”¨æˆ·ï¼‰
* æ¨é€ fan-out

Gateway ç‰¹æ€§ï¼š

* æ— æŒä¹…åŒ–ç”¨æˆ·æ•°æ®
* æœ¬åœ°ç¼“å­˜ï¼ˆçŸ­ TTLï¼‰
* å¯æ¨ªå‘æ‰©å±•ã€éšæ—¶é‡å¯

---

## 17. SeaKing è®¾è®¡è¯´æ˜

SeaKing æ˜¯ç³»ç»Ÿçš„ **ç”¨æˆ·ä¸å…³ç³»ä¸­æ¢**ï¼š

èŒè´£ï¼š

* æ³¨å†Œ / ç™»å½• / é‰´æƒ
* ç”¨æˆ·ç®¡ç†
* å¥½å‹å…³ç³» / ç¾¤æˆå‘˜ / è§’è‰²
* ç”¨æˆ·åœ¨çº¿çŠ¶æ€

åŸåˆ™ï¼š

* SeaKing ä¸ç›´æ¥æ¨æ¶ˆæ¯
* SeaKing ä¸å‚ä¸æ¶ˆæ¯å­˜å‚¨

---

## 18. Relay è®¾è®¡è¯´æ˜

Relay èŒè´£ï¼š

* Event å†™å…¥
* Event æŸ¥è¯¢ï¼ˆæŒ‰ cid / mid / æ—¶é—´ï¼‰

Relay åŸåˆ™ï¼š

* ä¸åæŸ¥ SeaKing
* ä¸ç†è§£ä¸šåŠ¡è¯­ä¹‰
* å¯ç‹¬ç«‹æ‰©å±•

---

## 19. æ–‡ä»¶ç³»ç»Ÿè®¾è®¡

æ–‡ä»¶æµï¼š

1. Client è¯·æ±‚ä¸Šä¼ å‡­è¯
2. Gateway/SeaKing è¿”å› presign
3. Client ç›´ä¼  S3
4. Client å‘é€ Kind=3 Event å¼•ç”¨æ–‡ä»¶

