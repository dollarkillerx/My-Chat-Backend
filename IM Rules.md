# Nostr-inspired 中心化 IM 技术架构设计文档

![](./README/v1.png)

## 1. 设计背景与目标

本系统是一套 **参考 Nostr 协议思想（Event / Relay / Client 解耦）**，但面向**工程落地与中心化运营**的即时通讯（IM）架构。

设计目标：

* 保留 Nostr 的 **事件模型（Event）** 与 **Relay 轻逻辑存储** 优点
* 提供中心化 IM 必需的 **账号、关系、权限、推送、风控** 能力
* 支持 **单聊 / 群聊 / 文件 / 回信 / 撤销** 等完整 IM 功能
* 协议层轻量（MsgPack）、可版本化、强扩展
---

## 2. 总体架构概览

系统由五类核心组件构成：

1. **Client（Mobile/Web）**：

   * 用户界面
   * 协议编解码（MsgPack）
   * 本地状态（会话、消息）

2. **Gateway 集群**（连接与推送层）：

   * 统一客户端入口
   * WebSocket 长连接管理
   * 鉴权、协议适配、消息路由与推送

3. **SeaKing（用户与关系中心）**：

   * Auth / 注册 / 登录
   * 用户管理
   * 用户关系（好友、群成员、角色）
   * 用户状态维护
   * 系统“真相源”（Source of Truth）

4. **Relay 集群（事件存储层）**：

   * 只负责事件存储与查询
   * 不理解业务语义
   * 可横向扩展

5. **对象存储（S3/OSS/COS）**：

   * 文件、图片、语音等大对象存储

---

## 3. 核心设计原则

### 3.1 职责严格拆分

| 模块      | 主要职责       | 不承担职责   |
| ------- | ---------- | ------- |
| Client  | UI、编解码、加解密 | 权限判断、存储 |
| Gateway | 连接、路由、推送   | 用户关系真相  |
| SeaKing | 用户/关系/权限   | 消息推送    |
| Relay   | 事件存储       | 业务逻辑    |
| S3      | 文件存储       | 消息索引    |

### 3.2 Relay 轻逻辑原则（Nostr 精神）

Relay 被设计为：

* **哑存储（Dumb Store）**
* 只理解 Event 的最小字段（cid / mid / kind / tags / payload）
* 不主动调用 SeaKing
* 不维护会话、成员、权限

---

## 4. 消息与事件模型

### 4.1 Event 总体模型

所有消息、控制行为都抽象为 **Event**。

Event 是系统中唯一的“消息原子”。

### 4.2 协议封装（Envelope）

所有网络消息使用 MsgPack Map 封装：

```
{
  0: v,        // 协议版本
  1: cmd,      // 命令类型
  2: seq,      // 客户端序列号
  3: sid,      // 会话ID（可选）
  4: body,     // 负载
  15: ext      // 扩展字段（可选）
}
```

### 4.3 Event Body 结构

```
body = {
  0: ev_v,     // 事件版本
  1: cid,      // 会话ID（单聊/群聊）
  2: k,        // kind（事件类型）
  3: mid,      // 消息ID（服务端生成）
  4: t,        // 时间戳（秒）
  5: flg,      // flags 位图
  6: tags,     // 关联标签
  7: data,     // 结构化消息体
  8: sig,      // 可选签名
  15: ext      // 扩展字段
}
```

---

## 5. 消息类型（Kinds）

| Kind | 含义         |
| ---- | ---------- |
| 1    | 文本消息       |
| 3    | 文件消息（引用文件） |
| 5    | 撤销消息       |

### 5.1 文本消息（Kind=1）

```
data = {
  0: "hello world"
}
```

### 5.2 文件消息（Kind=3）

```
data = {
  0: fid,        // 文件ID
  1: name,       // 文件名
  2: size,       // 文件大小
  3: mime,       // MIME
  4: sha256,     // 哈希
  5: url         // 下载地址
}
```

---

## 6. 回信（Reply）设计

### 6.1 Reply 的建模方式

* Reply 不引入新 kind
* 使用 **tags** 建立引用关系

### 6.2 Reply Tag 定义

```
[1, mid]   // reply_to
```

### 6.3 示例

```
tags = [ [1, 9000123] ]
data = { 0: "收到" }
```

---

## 7. 撤销消息（Revoke）设计

### 7.1 撤销模型

* 撤销是一个新的 Event
* 不物理删除原消息

### 7.2 Revoke Kind

| Kind | 含义   |
| ---- | ---- |
| 5    | 撤销消息 |

### 7.3 Revoke Tag

```
[6, mid]   // revoke_target
```

### 7.4 Revoke Data

```
data = {
  0: scope,     // 1=全体可见, 2=仅自己
  1: reason     // 撤销原因（可选）
}
```

### 7.5 服务端校验规则

* 目标消息必须存在且属于同 cid
* 单聊：只能撤销自己发送的消息
* 群聊：

  * 普通用户：撤销自己消息
  * 管理员：可撤销他人消息
* 可配置时间窗口（如 2 分钟）

---

## 8. Gateway 设计说明

Gateway 负责：

* WebSocket 连接管理
* 鉴权（token → uid）
* 消息路由（cid → 在线用户）
* 推送 fan-out

Gateway 特性：

* 无持久化用户数据
* 本地缓存（短 TTL）
* 可横向扩展、随时重启

---

## 9. SeaKing 设计说明

SeaKing 是系统的 **用户与关系中枢**：

职责：

* 注册 / 登录 / 鉴权
* 用户管理
* 好友关系 / 群成员 / 角色
* 用户在线状态

原则：

* SeaKing 不直接推消息
* SeaKing 不参与消息存储

---

## 10. Relay 设计说明

Relay 职责：

* Event 写入
* Event 查询（按 cid / mid / 时间）

Relay 原则：

* 不反查 SeaKing
* 不理解业务语义
* 可独立扩展

---

## 11. 文件系统设计

文件流：

1. Client 请求上传凭证
2. Gateway/SeaKing 返回 presign
3. Client 直传 S3
4. Client 发送 Kind=3 Event 引用文件

